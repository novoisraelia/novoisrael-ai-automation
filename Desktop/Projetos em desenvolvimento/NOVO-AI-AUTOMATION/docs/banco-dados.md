# üóÑÔ∏è Banco de Dados - Schema e Relacionamentos

## Diagrama ER (Entidade-Relacionamento)

```mermaid
erDiagram
    CUSTOMERS {
        uuid id PK
        string phone UK
        string nome
        string titulo
        decimal saldo_pontos
        jsonb perfil
        decimal desconto
        timestamp created_at
        timestamp updated_at
        timestamp last_interaction
    }
    
    PRODUCTS {
        uuid id PK
        string name
        text description
        decimal price
        decimal original_price
        string category
        string[] tags
        boolean is_active
        string sku
        integer stock
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    TRANSACTIONS {
        uuid id PK
        uuid customer_id FK
        decimal subtotal
        decimal discount_amount
        decimal total
        string status
        string payment_method
        jsonb products
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    CONVERSATIONS {
        uuid id PK
        uuid customer_id FK
        string message_type
        text content
        string intent
        text ai_response
        jsonb metadata
        timestamp created_at
    }
    
    CART_ITEMS {
        uuid id PK
        uuid customer_id FK
        uuid product_id FK
        integer quantity
        decimal unit_price
        decimal total_price
        timestamp created_at
        timestamp updated_at
    }
    
    DISCOUNTS {
        uuid id PK
        string code
        decimal percentage
        decimal max_value
        decimal min_value
        timestamp expires_at
        boolean is_active
        integer usage_limit
        integer usage_count
        string[] applicable_products
        timestamp created_at
    }
    
    AUDIT_LOGS {
        uuid id PK
        string action
        string entity_type
        string entity_id
        uuid user_id FK
        jsonb old_values
        jsonb new_values
        string ip_address
        string user_agent
        timestamp created_at
    }
    
    SYSTEM_USERS {
        uuid id PK
        string username UK
        string email UK
        string role
        boolean is_active
        string[] permissions
        timestamp last_login
        timestamp created_at
        timestamp updated_at
    }
    
    NOTIFICATIONS {
        uuid id PK
        string type
        string recipient
        string subject
        text content
        string status
        integer attempts
        integer max_attempts
        timestamp scheduled_for
        timestamp sent_at
        text error
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }
    
    %% Relacionamentos
    CUSTOMERS ||--o{ TRANSACTIONS : "realiza"
    CUSTOMERS ||--o{ CONVERSATIONS : "participa"
    CUSTOMERS ||--o{ CART_ITEMS : "possui"
    
    PRODUCTS ||--o{ CART_ITEMS : "cont√©m"
    PRODUCTS ||--o{ TRANSACTIONS : "vendido_em"
    
    DISCOUNTS ||--o{ TRANSACTIONS : "aplicado_em"
    
    SYSTEM_USERS ||--o{ AUDIT_LOGS : "registra"
```

## Tabelas Detalhadas

### üìã CUSTOMERS (Clientes)

**Prop√≥sito**: Armazena dados dos clientes/leads do sistema.

| Campo | Tipo | Descri√ß√£o | Restri√ß√µes |
|-------|------|-----------|------------|
| `id` | `uuid` | Identificador √∫nico | PK, NOT NULL |
| `phone` | `string` | Telefone do cliente | UK, NOT NULL |
| `nome` | `string` | Nome do cliente | NULLABLE |
| `titulo` | `string` | T√≠tulo (Pastor, Bispo, etc.) | NULLABLE |
| `saldo_pontos` | `decimal(10,2)` | Saldo de pontos (1 ponto = R$1) | DEFAULT 0 |
| `perfil` | `jsonb` | Perfil detectado (pastor, jovem, m√£e, neutro) | NULLABLE |
| `desconto` | `decimal(5,2)` | Percentual de desconto personalizado | DEFAULT 0 |
| `created_at` | `timestamp` | Data de cria√ß√£o | NOT NULL |
| `updated_at` | `timestamp` | Data de atualiza√ß√£o | NOT NULL |
| `last_interaction` | `timestamp` | √öltima intera√ß√£o | NULLABLE |

**√çndices**:
- `idx_customers_phone` - Busca por telefone
- `idx_customers_titulo` - Busca por t√≠tulo
- `idx_customers_last_interaction` - Ordena√ß√£o por intera√ß√£o

### üì¶ PRODUCTS (Produtos)

**Prop√≥sito**: Cat√°logo de produtos sincronizado com Conta Azul.

| Campo | Tipo | Descri√ß√£o | Restri√ß√µes |
|-------|------|-----------|------------|
| `id` | `uuid` | Identificador √∫nico | PK, NOT NULL |
| `name` | `string` | Nome do produto | NOT NULL |
| `description` | `text` | Descri√ß√£o detalhada | NULLABLE |
| `price` | `decimal(10,2)` | Pre√ßo atual | NOT NULL |
| `original_price` | `decimal(10,2)` | Pre√ßo original | NULLABLE |
| `category` | `string` | Categoria do produto | NULLABLE |
| `tags` | `string[]` | Tags para busca | NULLABLE |
| `is_active` | `boolean` | Produto ativo | DEFAULT true |
| `sku` | `string` | SKU do produto | UK, NULLABLE |
| `stock` | `integer` | Quantidade em estoque | DEFAULT 0 |
| `metadata` | `jsonb` | Metadados adicionais | NULLABLE |
| `created_at` | `timestamp` | Data de cria√ß√£o | NOT NULL |
| `updated_at` | `timestamp` | Data de atualiza√ß√£o | NOT NULL |

**√çndices**:
- `idx_products_name` - Busca por nome
- `idx_products_category` - Busca por categoria
- `idx_products_tags` - Busca por tags (GIN)
- `idx_products_is_active` - Filtro por ativo

### üí∞ TRANSACTIONS (Transa√ß√µes)

**Prop√≥sito**: Registra todas as vendas realizadas.

| Campo | Tipo | Descri√ß√£o | Restri√ß√µes |
|-------|------|-----------|------------|
| `id` | `uuid` | Identificador √∫nico | PK, NOT NULL |
| `customer_id` | `uuid` | ID do cliente | FK, NOT NULL |
| `subtotal` | `decimal(10,2)` | Subtotal da venda | NOT NULL |
| `discount_amount` | `decimal(10,2)` | Valor do desconto | DEFAULT 0 |
| `total` | `decimal(10,2)` | Valor total | NOT NULL |
| `status` | `string` | Status da transa√ß√£o | NOT NULL |
| `payment_method` | `string` | M√©todo de pagamento | NULLABLE |
| `products` | `jsonb` | Produtos vendidos | NOT NULL |
| `metadata` | `jsonb` | Metadados da transa√ß√£o | NULLABLE |
| `created_at` | `timestamp` | Data de cria√ß√£o | NOT NULL |
| `updated_at` | `timestamp` | Data de atualiza√ß√£o | NOT NULL |

**Status poss√≠veis**: `pending`, `completed`, `cancelled`, `refunded`

**√çndices**:
- `idx_transactions_customer_id` - Busca por cliente
- `idx_transactions_status` - Filtro por status
- `idx_transactions_created_at` - Ordena√ß√£o por data

### üí¨ CONVERSATIONS (Conversas)

**Prop√≥sito**: Hist√≥rico de conversas com clientes.

| Campo | Tipo | Descri√ß√£o | Restri√ß√µes |
|-------|------|-----------|------------|
| `id` | `uuid` | Identificador √∫nico | PK, NOT NULL |
| `customer_id` | `uuid` | ID do cliente | FK, NOT NULL |
| `message_type` | `string` | Tipo da mensagem | NOT NULL |
| `content` | `text` | Conte√∫do da mensagem | NOT NULL |
| `intent` | `string` | Inten√ß√£o detectada | NULLABLE |
| `ai_response` | `text` | Resposta da IA | NULLABLE |
| `metadata` | `jsonb` | Metadados da conversa | NULLABLE |
| `created_at` | `timestamp` | Data de cria√ß√£o | NOT NULL |

**Tipos de mensagem**: `text`, `image`, `audio`, `video`, `document`

**√çndices**:
- `idx_conversations_customer_id` - Busca por cliente
- `idx_conversations_intent` - Filtro por inten√ß√£o
- `idx_conversations_created_at` - Ordena√ß√£o por data

### üõí CART_ITEMS (Itens do Carrinho)

**Prop√≥sito**: Itens no carrinho de compras dos clientes.

| Campo | Tipo | Descri√ß√£o | Restri√ß√µes |
|-------|------|-----------|------------|
| `id` | `uuid` | Identificador √∫nico | PK, NOT NULL |
| `customer_id` | `uuid` | ID do cliente | FK, NOT NULL |
| `product_id` | `uuid` | ID do produto | FK, NOT NULL |
| `quantity` | `integer` | Quantidade | NOT NULL |
| `unit_price` | `decimal(10,2)` | Pre√ßo unit√°rio | NOT NULL |
| `total_price` | `decimal(10,2)` | Pre√ßo total | NOT NULL |
| `created_at` | `timestamp` | Data de cria√ß√£o | NOT NULL |
| `updated_at` | `timestamp` | Data de atualiza√ß√£o | NOT NULL |

**√çndices**:
- `idx_cart_items_customer_id` - Busca por cliente
- `idx_cart_items_product_id` - Busca por produto

### üé´ DISCOUNTS (Descontos)

**Prop√≥sito**: C√≥digos de desconto e promo√ß√µes.

| Campo | Tipo | Descri√ß√£o | Restri√ß√µes |
|-------|------|-----------|------------|
| `id` | `uuid` | Identificador √∫nico | PK, NOT NULL |
| `code` | `string` | C√≥digo do desconto | UK, NOT NULL |
| `percentage` | `decimal(5,2)` | Percentual de desconto | NOT NULL |
| `max_value` | `decimal(10,2)` | Valor m√°ximo do desconto | NULLABLE |
| `min_value` | `decimal(10,2)` | Valor m√≠nimo para aplicar | NULLABLE |
| `expires_at` | `timestamp` | Data de expira√ß√£o | NULLABLE |
| `is_active` | `boolean` | Desconto ativo | DEFAULT true |
| `usage_limit` | `integer` | Limite de uso | NULLABLE |
| `usage_count` | `integer` | Contador de uso | DEFAULT 0 |
| `applicable_products` | `string[]` | Produtos aplic√°veis | NULLABLE |
| `created_at` | `timestamp` | Data de cria√ß√£o | NOT NULL |

**√çndices**:
- `idx_discounts_code` - Busca por c√≥digo
- `idx_discounts_is_active` - Filtro por ativo
- `idx_discounts_expires_at` - Filtro por expira√ß√£o

## üîó Relacionamentos

### 1:N (Um para Muitos)
- **CUSTOMERS ‚Üí TRANSACTIONS**: Um cliente pode ter v√°rias transa√ß√µes
- **CUSTOMERS ‚Üí CONVERSATIONS**: Um cliente pode ter v√°rias conversas
- **CUSTOMERS ‚Üí CART_ITEMS**: Um cliente pode ter v√°rios itens no carrinho
- **PRODUCTS ‚Üí CART_ITEMS**: Um produto pode estar em v√°rios carrinhos
- **PRODUCTS ‚Üí TRANSACTIONS**: Um produto pode estar em v√°rias transa√ß√µes

### N:M (Muitos para Muitos)
- **DISCOUNTS ‚Üî TRANSACTIONS**: Um desconto pode ser aplicado em v√°rias transa√ß√µes, uma transa√ß√£o pode ter v√°rios descontos

## üìä Views e Fun√ß√µes √öteis

### View: Customer Summary
```sql
CREATE VIEW customer_summary AS
SELECT 
    c.id,
    c.phone,
    c.nome,
    c.titulo,
    c.saldo_pontos,
    COUNT(t.id) as total_transactions,
    COALESCE(SUM(t.total), 0) as total_spent,
    MAX(c.last_interaction) as last_interaction
FROM customers c
LEFT JOIN transactions t ON c.id = t.customer_id
GROUP BY c.id, c.phone, c.nome, c.titulo, c.saldo_pontos;
```

### View: Product Performance
```sql
CREATE VIEW product_performance AS
SELECT 
    p.id,
    p.name,
    p.category,
    p.price,
    COUNT(ci.id) as times_added_to_cart,
    COUNT(t.id) as times_sold,
    COALESCE(SUM(ci.quantity), 0) as total_quantity_cart,
    COALESCE(SUM(t.products->>'quantity'), 0) as total_quantity_sold
FROM products p
LEFT JOIN cart_items ci ON p.id = ci.product_id
LEFT JOIN transactions t ON p.id = (t.products->>'product_id')::uuid
GROUP BY p.id, p.name, p.category, p.price;
```

## üîß Configura√ß√µes de Performance

### √çndices Compostos
```sql
-- Busca de conversas por cliente e data
CREATE INDEX idx_conversations_customer_date 
ON conversations(customer_id, created_at DESC);

-- Busca de transa√ß√µes por cliente e status
CREATE INDEX idx_transactions_customer_status 
ON transactions(customer_id, status, created_at DESC);

-- Busca de produtos por categoria e ativo
CREATE INDEX idx_products_category_active 
ON products(category, is_active) WHERE is_active = true;
```

### Particionamento (Futuro)
```sql
-- Particionar conversas por m√™s
CREATE TABLE conversations_2024_01 PARTITION OF conversations
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

## üö® Pol√≠ticas de Seguran√ßa (RLS)

### Row Level Security
```sql
-- Habilitar RLS em todas as tabelas
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica para clientes (apenas seus pr√≥prios dados)
CREATE POLICY customer_own_data ON customers
FOR ALL USING (phone = current_setting('app.current_phone'));
```

## üìà M√©tricas e Monitoramento

### Queries de M√©tricas
```sql
-- Total de clientes ativos (√∫ltimos 30 dias)
SELECT COUNT(*) FROM customers 
WHERE last_interaction > NOW() - INTERVAL '30 days';

-- Receita total por m√™s
SELECT 
    DATE_TRUNC('month', created_at) as month,
    SUM(total) as revenue
FROM transactions 
WHERE status = 'completed'
GROUP BY month
ORDER BY month;

-- Produtos mais vendidos
SELECT 
    p.name,
    COUNT(t.id) as sales_count,
    SUM((t.products->>'quantity')::integer) as total_quantity
FROM products p
JOIN transactions t ON p.id = (t.products->>'product_id')::uuid
WHERE t.status = 'completed'
GROUP BY p.id, p.name
ORDER BY sales_count DESC
LIMIT 10;
```
